<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI 旅行助手</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- 高德地图SDK将在JavaScript中动态加载 -->
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      height: 100vh;
      overflow: hidden;
    }
    
    .container {
      position: relative;
      width: 100%;
      height: 100vh;
    }
    
    #map {
      width: 100%;
      height: 100%;
      z-index: 1;
    }
    
    .chat-container {
      position: absolute;
      bottom: 20px;
      right: 20px;
      width: 380px;
      max-width: calc(100vw - 40px);
      height: 500px;
      max-height: calc(100vh - 80px);
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      z-index: 100;
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease;
    }
    
    .chat-container.minimized {
      width: 60px;
      height: 60px;
      border-radius: 50%;
    }
    
    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background-color: #2563eb;
      color: white;
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
    }
    
    .chat-header h3 {
      font-size: 16px;
      font-weight: 500;
    }
    
    .minimize-btn {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }
    
    .minimize-btn:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }
    
    .chat-messages {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .message {
      max-width: 85%;
      padding: 10px 16px;
      border-radius: 16px;
      line-height: 1.5;
      font-size: 14px;
    }
    
    .user-message {
      align-self: flex-end;
      background-color: #2563eb;
      color: white;
      border-bottom-right-radius: 4px;
    }
    
    .assistant-message {
      align-self: flex-start;
      background-color: #f1f5f9;
      color: #1e293b;
      border-bottom-left-radius: 4px;
    }
    
    .chat-input {
      padding: 12px;
      border-top: 1px solid #e2e8f0;
      display: flex;
      gap: 8px;
    }
    
    .chat-input input {
      flex: 1;
      padding: 12px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      outline: none;
      font-size: 14px;
    }
    
    .chat-input input:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
    }
    
    .send-btn {
      background-color: #2563eb;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 0 16px;
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.2s;
    }
    
    .send-btn:hover {
      background-color: #1d4ed8;
    }
    
    .send-btn:disabled {
      background-color: #93c5fd;
      cursor: not-allowed;
    }
    
    .chat-bubble {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background-color: #2563eb;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }
    
    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .typing-dot {
      width: 8px;
      height: 8px;
      background-color: #94a3b8;
      border-radius: 50%;
      animation: typing-animation 1.4s infinite ease-in-out;
    }
    
    .typing-dot:nth-child(1) {
      animation-delay: 0s;
    }
    
    .typing-dot:nth-child(2) {
      animation-delay: 0.2s;
    }
    
    .typing-dot:nth-child(3) {
      animation-delay: 0.4s;
    }
    
    @keyframes typing-animation {
      0%, 100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-5px);
      }
    }
    
    .popup-image {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 8px;
    }
    
    .about-link {
      position: absolute;
      top: 20px;
      right: 20px;
      background-color: white;
      padding: 8px 16px;
      border-radius: 6px;
      color: #2563eb;
      text-decoration: none;
      font-weight: 500;
      font-size: 14px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      z-index: 10;
      transition: background-color 0.2s;
    }
    
    .about-link:hover {
      background-color: #f8fafc;
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="#about" class="about-link" onclick="showAbout(); return false;">关于项目</a>
    
    <div id="map">
      <div style="display:flex;justify-content:center;align-items:center;height:100%;background:#f5f7f9;">
        <div style="text-align:center;">
          <div style="margin-bottom:15px;">加载地图中...</div>
          <div class="typing-indicator" style="justify-content:center;">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="chat-container" id="chatContainer">
      <div class="chat-header">
        <h3>AI 旅行 & 通用助手</h3>
        <button class="minimize-btn" id="minimizeBtn">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M2 8a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11A.5.5 0 0 1 2 8Z"/>
          </svg>
        </button>
      </div>
      
      <div class="chat-messages" id="chatMessages">
        <div class="message assistant-message">
          你好！我是你的AI助手。不仅可以回答旅行相关问题，还可以聊其他话题。尝试问我关于旅游景点、餐厅推荐，或者任何你感兴趣的话题！
        </div>
      </div>
      
      <form class="chat-input" id="chatForm">
        <input type="text" id="chatInput" placeholder="问我任何问题...">
        <button type="submit" class="send-btn" id="sendBtn">发送</button>
      </form>
    </div>
    
    <div class="chat-bubble" id="chatBubble" style="display: none;">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
        <path d="M8 15c4.418 0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7c0 1.76.743 3.37 1.97 4.6-.097 1.016-.417 2.13-.771 2.966-.079.186.074.394.273.362 2.256-.37 3.597-.938 4.18-1.234A9.06 9.06 0 0 0 8 15z"/>
      </svg>
    </div>
  </div>
  
  <div id="aboutModal" style="display: none; position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); z-index: 200; display: flex; align-items: center; justify-content: center; padding: 20px;">
    <div style="background-color: white; max-width: 600px; width: 100%; border-radius: 12px; padding: 24px; max-height: 90vh; overflow-y: auto;">
      <h2 style="font-size: 24px; color: #2563eb; margin-bottom: 16px;">关于 AI 旅行 & 通用助手</h2>
      
      <div style="margin-bottom: 24px;">
        <h3 style="font-size: 18px; margin-bottom: 12px;">项目介绍</h3>
        <p style="line-height: 1.6; color: #334155; margin-bottom: 12px;">
          AI 旅行 & 通用助手是一个基于 OpenStreetMap 和 DeepSeek AI 开发的智能对话工具。
          不仅可以帮助用户探索中国各地的旅游景点和目的地信息，还能回答各类通用问题。
        </p>
        <p style="line-height: 1.6; color: #334155;">
          本项目采用了轻量级前端技术，提供了流畅的用户体验和丰富的交互功能。
        </p>
      </div>
      
      <div style="margin-bottom: 24px;">
        <h3 style="font-size: 18px; margin-bottom: 12px;">主要功能</h3>
        <ul style="padding-left: 20px; line-height: 1.6; color: #334155;">
          <li style="margin-bottom: 8px;">通过 AI 聊天界面获取各类信息</li>
          <li style="margin-bottom: 8px;">旅游相关问题会在地图上显示目的地位置</li>
          <li style="margin-bottom: 8px;">查看目的地详情和图片</li>
          <li style="margin-bottom: 8px;">回答通用知识和信息检索类问题</li>
          <li style="margin-bottom: 8px;">响应式设计，适配各种设备</li>
        </ul>
      </div>
      
      <div style="margin-bottom: 24px;">
        <h3 style="font-size: 18px; margin-bottom: 12px;">技术栈</h3>
        <ul style="padding-left: 20px; line-height: 1.6; color: #334155;">
          <li style="margin-bottom: 8px;">HTML/CSS/JavaScript</li>
          <li style="margin-bottom: 8px;">Leaflet 地图</li>
          <li style="margin-bottom: 8px;">DeepSeek AI API</li>
          <li style="margin-bottom: 8px;">Cloudflare Pages Functions</li>
        </ul>
      </div>
      
      <button onclick="hideAbout()" style="background-color: #2563eb; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 500;">关闭</button>
    </div>
  </div>

  <script>
    // 初始化高德地图
    let map = null;
    let mapMarkers = []; // 景点标记数组
    let cityPolygon = null; // 城市边界多边形
    let routeLine = null; // 路线线条
    let mapReady = false; // 地图就绪状态标志
    
    // 聊天相关变量和元素
    const chatContainer = document.getElementById('chatContainer');
    const chatBubble = document.getElementById('chatBubble');
    const minimizeBtn = document.getElementById('minimizeBtn');
    const chatMessages = document.getElementById('chatMessages');
    const chatForm = document.getElementById('chatForm');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const aboutModal = document.getElementById('aboutModal');
    
    // 动态加载高德地图SDK
    async function loadMapSDK() {
      try {
        // 从API获取密钥
        console.log('开始获取高德地图API密钥...');
        const response = await fetch('/api/gaode-key');
        console.log('API密钥请求状态:', response.status, response.statusText);
        
        // 显示更详细的错误信息
        if (!response.ok) {
          const errorText = await response.text();
          console.error('获取API密钥失败，详细信息:', errorText);
          throw new Error(`无法获取地图API密钥: ${response.status} ${response.statusText} - ${errorText}`);
        }
        
        const data = await response.json();
        console.log('获取到API密钥响应:', data);
        
        if (data.error || !data.key) {
          throw new Error(data.error || '无效的API密钥');
        }
        
        const apiKey = data.key;
        console.log('API密钥获取成功:', apiKey.substring(0, 3) + '***', '开始加载地图SDK...');
        
        // 创建高德地图脚本
        return new Promise((resolve, reject) => {
          // 加载主地图API - 使用正确的Web端JavaScript API接口
          const mapScript = document.createElement('script');
          mapScript.src = `https://webapi.amap.com/maps?v=2.0&key=${apiKey}&plugin=AMap.Scale,AMap.ToolBar,AMap.DistrictSearch,AMap.PlaceSearch,AMap.Driving&callback=initAMap`;
          mapScript.async = true;
          
          // 添加全局回调函数
          window.initAMap = function() {
            console.log('高德地图API加载成功 - 回调函数触发');
            
            // 加载UI组件库
            const uiScript = document.createElement('script');
            uiScript.src = 'https://webapi.amap.com/ui/1.1/main.js?v=1.1';
            uiScript.async = true;
            
            uiScript.onload = () => {
              console.log('高德地图UI库加载成功');
              resolve(); // 两个脚本都加载完成
            };
            
            uiScript.onerror = (e) => {
              console.error('无法加载高德地图UI组件:', e);
              reject(new Error('无法加载高德地图UI组件'));
            };
            
            document.head.appendChild(uiScript);
          };
          
          mapScript.onerror = (e) => {
            console.error('无法加载高德地图API:', e);
            reject(new Error('无法加载高德地图API'));
          };
          
          document.head.appendChild(mapScript);
        });
      } catch (error) {
        console.error('加载地图SDK出错:', error);
        // 显示错误消息
        const mapDiv = document.getElementById('map');
        if (mapDiv) {
          mapDiv.innerHTML = `
            <div style="display:flex;justify-content:center;align-items:center;height:100%;flex-direction:column;background:#f9f9f9;">
              <h3 style="color:#e74c3c">地图加载失败</h3>
              <p>${error.message}</p>
              <p>请检查控制台获取更多详细信息</p>
              <button onclick="location.reload()" style="padding:8px 16px;background:#3498db;color:white;border:none;border-radius:4px;cursor:pointer;margin-top:10px;">
                重新加载
              </button>
            </div>
          `;
        }
        throw error;
      }
    }
    
    // 初始化地图
    async function initMap() {
      try {
        console.log('开始加载高德地图SDK...');
        // 先加载地图SDK
        await loadMapSDK();
        
        console.log('创建地图实例...');
        // 创建地图实例
        map = new AMap.Map('map', {
          zoom: 4,
          center: [105.0, 35.0], // 中国中心点
          viewMode: '2D'
        });
        
        console.log('地图实例创建成功，添加控件...');
        // 添加控件
        map.plugin(['AMap.ToolBar', 'AMap.Scale'], function() {
          // 添加工具条
          const toolBar = new AMap.ToolBar({
            position: 'RT'
          });
          map.addControl(toolBar);
          
          // 添加比例尺
          const scale = new AMap.Scale();
          map.addControl(scale);
          
          console.log('地图控件添加完成');
        });
        
        // 添加地图加载完成事件
        map.on('complete', function() {
          console.log('地图渲染完成事件触发');
          
          // 标记地图已就绪
          mapReady = true;
          console.log('地图已就绪，可以使用');
          
          // 触发自定义事件
          window.dispatchEvent(new CustomEvent('mapReady'));
          
          // 添加测试标记，确认地图功能正常
          console.log('添加测试标记到北京位置');
          const marker = new AMap.Marker({
            position: [116.4074, 39.9042], // 北京坐标
            title: '测试标记 - 北京'
          });
          marker.setMap(map); // 使用setMap而不是addTo
        });
      } catch (error) {
        console.error('初始化地图出错:', error);
        // 显示错误信息到界面
        const mapDiv = document.getElementById('map');
        if (mapDiv) {
          mapDiv.innerHTML = `
            <div style="display:flex;justify-content:center;align-items:center;height:100%;flex-direction:column;background:#f5f7f9;padding:20px;text-align:center;">
              <h3 style="color:#e74c3c;margin-bottom:10px;">地图加载失败</h3>
              <p style="margin-bottom:10px;">错误信息: ${error.message}</p>
              <button onclick="location.reload()" style="padding:8px 16px;background:#3498db;color:white;border:none;border-radius:4px;cursor:pointer;">
                重新加载
              </button>
            </div>
          `;
        }
      }
    }
    
    // 等待地图就绪的函数
    function waitForMap(timeout = 10000) {
      // 如果地图已就绪，立即返回
      if (mapReady && map) {
        return Promise.resolve();
      }
      
      // 否则创建一个Promise等待地图就绪事件
      return new Promise((resolve, reject) => {
        // 设置超时
        const timeoutId = setTimeout(() => {
          reject(new Error('等待地图初始化超时'));
        }, timeout);
        
        // 监听地图就绪事件
        window.addEventListener('mapReady', function onMapReady() {
          clearTimeout(timeoutId);
          window.removeEventListener('mapReady', onMapReady);
          resolve();
        });
      });
    }
    
    // 页面加载完成后初始化地图
    document.addEventListener('DOMContentLoaded', initMap);
    
    // 中国主要城市数据
    const citiesData = [
      { 
        name: '北京', 
        lat: 39.9042, 
        lng: 116.4074, 
        description: '中国首都，拥有丰富的历史文化遗产', 
        image: 'https://images.unsplash.com/photo-1584283367830-7875dd39f6e7?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxzZWFyY2h8MTB8fGJlaWppbmd8ZW58MHx8MHx8&auto=format&fit=crop&w=500&q=60',
        rating: 4.8
      },
      { 
        name: '上海', 
        lat: 31.2304, 
        lng: 121.4737, 
        description: '中国最大的城市和全球金融中心之一', 
        image: 'https://images.unsplash.com/photo-1548919973-5cef591cdbc9?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxzZWFyY2h8NXx8c2hhbmdoYWl8ZW58MHx8MHx8&auto=format&fit=crop&w=500&q=60',
        rating: 4.7
      },
      { 
        name: '广州', 
        lat: 23.1291, 
        lng: 113.2644, 
        description: '中国南方的商业和文化中心', 
        image: 'https://images.unsplash.com/photo-1583591424399-7d3167fda79d?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxzZWFyY2h8MTF8fGd1YW5nemhvdXxlbnwwfHwwfHw%3D&auto=format&fit=crop&w=500&q=60',
        rating: 4.5
      },
      { 
        name: '深圳', 
        lat: 22.5431, 
        lng: 114.0579, 
        description: '中国创新科技的前沿城市', 
        image: 'https://images.unsplash.com/photo-1546382102-368825d3a4fd?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxzZWFyY2h8Mnx8c2hlbnpoZW58ZW58MHx8MHx8&auto=format&fit=crop&w=500&q=60',
        rating: 4.6
      },
      { 
        name: '西安', 
        lat: 34.3416, 
        lng: 108.9398, 
        description: '中国古代文明的摇篮之一，拥有兵马俑等文化遗产', 
        image: 'https://images.unsplash.com/photo-1619852742746-51f6dab01733?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxzZWFyY2h8Mnx8eGlhbiUyMGNoaW5hfGVufDB8fDB8fA%3D%3D&auto=format&fit=crop&w=500&q=60',
        rating: 4.7
      },
      { 
        name: '成都', 
        lat: 30.5728, 
        lng: 104.0668, 
        description: '中国西南地区的中心城市，以熊猫和美食闻名', 
        image: 'https://images.unsplash.com/photo-1585211969224-3e992986159d?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxzZWFyY2h8NHx8Y2hlbmdkdXxlbnwwfHwwfHw%3D&auto=format&fit=crop&w=500&q=60',
        rating: 4.8
      }
    ];
    
    // 已添加的标记
    const markers = [];
    let selectedMarker = null;
    
    // 最小化和最大化聊天框
    minimizeBtn.addEventListener('click', () => {
      chatContainer.classList.add('minimized');
      setTimeout(() => {
        chatContainer.style.display = 'none';
        chatBubble.style.display = 'flex';
      }, 300);
    });
    
    chatBubble.addEventListener('click', () => {
      chatBubble.style.display = 'none';
      chatContainer.style.display = 'flex';
      setTimeout(() => {
        chatContainer.classList.remove('minimized');
      }, 10);
    });
    
    // 处理聊天表单提交
    chatForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const message = chatInput.value.trim();
      if (!message) return;
      
      // 添加用户消息
      addMessage(message, 'user');
      chatInput.value = '';
      
      // 禁用输入和发送按钮
      chatInput.disabled = true;
      sendBtn.disabled = true;
      
      // 显示AI思考中
      addThinkingIndicator();
      
      try {
        // 获取AI回复
        const response = await generateResponse(message);
        
        // 移除思考指示器
        removeThinkingIndicator();
        
        // 添加AI回复
        addMessage(response, 'assistant');
        
        // 分析AI回答中的地理信息并在地图上显示
        console.log('开始分析地理信息...');
        await processGeographicInfo(message, response);
      } catch (error) {
        // 移除思考指示器
        removeThinkingIndicator();
        
        // 显示错误消息
        addMessage('抱歉，我暂时无法回答您的问题。请稍后再试。', 'assistant');
        console.error('Error:', error);
      } finally {
        // 重新启用输入和发送按钮
        chatInput.disabled = false;
        sendBtn.disabled = false;
        chatInput.focus();
      }
    });
    
    // 添加消息到聊天框
    function addMessage(content, role) {
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('message');
      messageDiv.classList.add(role === 'user' ? 'user-message' : 'assistant-message');
      messageDiv.textContent = content;
      
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // 添加思考指示器
    function addThinkingIndicator() {
      const indicatorDiv = document.createElement('div');
      indicatorDiv.classList.add('message', 'assistant-message', 'thinking-indicator');
      indicatorDiv.id = 'thinkingIndicator';
      
      const dot1 = document.createElement('div');
      const dot2 = document.createElement('div');
      const dot3 = document.createElement('div');
      
      dot1.classList.add('typing-dot');
      dot2.classList.add('typing-dot');
      dot3.classList.add('typing-dot');
      
      indicatorDiv.appendChild(dot1);
      indicatorDiv.appendChild(dot2);
      indicatorDiv.appendChild(dot3);
      
      chatMessages.appendChild(indicatorDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // 移除思考指示器
    function removeThinkingIndicator() {
      const indicator = document.getElementById('thinkingIndicator');
      if (indicator) {
        indicator.remove();
      }
    }
    
    // 根据用户输入生成响应
    async function generateResponse(input) {
      try {
        // 调用我们的Cloudflare Pages Function
        const response = await fetch('/api/deepseek', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: input })
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          console.error('API错误:', errorData);
          throw new Error('API请求失败: ' + (errorData.error || '未知错误'));
        }
        
        const data = await response.json();
        console.log('DeepSeek响应:', data);
        
        // 检查新的响应格式
        if (data.content) {
          return data.content;
        } else if (data.error) {
          throw new Error('API错误: ' + data.error);
        } else {
          throw new Error('API返回了无效的响应格式');
        }
      } catch (error) {
        console.error('调用DeepSeek API出错:', error);
        
        // 回退到本地应答逻辑
        const inputLower = input.toLowerCase();
        
        if (inputLower.includes('北京')) {
          return '北京是中国的首都，有许多著名景点，如故宫、天安门广场和长城。您可以参观故宫博物院、天坛、颐和园，或者去郊区的八达岭长城和明十三陵游览。';
        } else if (inputLower.includes('上海')) {
          return '上海是中国最大的城市，是一个国际化大都市，有外滩、东方明珠等著名景点。您可以游览外滩的殖民地建筑群，参观豫园，或者去新天地体验上海的现代与传统融合。';
        } else if (inputLower.includes('广州')) {
          return '广州是中国南方的商业和文化中心，粤菜的发源地。您可以参观陈家祠、沙面岛、广州塔，品尝地道的粤菜和早茶。';
        } else if (inputLower.includes('深圳')) {
          return '深圳是中国改革开放的窗口，一座现代化的创新城市。您可以游览深圳世界之窗、欢乐谷、大梅沙海滩，或者去深圳湾公园散步。';
        } else if (inputLower.includes('西安')) {
          return '西安是中国古代文明的摇篮之一，拥有兵马俑等文化遗产。您可以参观秦始皇兵马俑博物馆、古城墙、大雁塔，品尝著名的西安小吃如肉夹馍和羊肉泡馍。';
        } else if (inputLower.includes('成都')) {
          return '成都是中国西南地区的中心城市，以熊猫和美食闻名。您可以去成都大熊猫繁育研究基地看熊猫，游览杜甫草堂、武侯祠，品尝正宗的川菜和火锅。';
        } else if (inputLower.includes('旅游') || inputLower.includes('景点') || inputLower.includes('去哪')) {
          return '中国有许多著名的旅游景点，例如北京的长城、西安的兵马俑、桂林的山水等。您想了解哪个城市的旅游信息呢？您可以询问我关于北京、上海、广州、深圳、西安、成都等城市的信息。';
        } else if (inputLower.includes('你好') || inputLower.includes('嗨') || inputLower === 'hi' || inputLower === 'hello') {
          return '你好！我是您的旅行助手。请问您想了解哪个城市或景点的信息？';
        } else {
          return '抱歉，我没有理解您的问题。您可以询问我关于中国主要城市（如北京、上海、广州、深圳、西安、成都等）的旅游信息。';
        }
      }
    }
    
    // 关于模态框的函数
    function showAbout() {
      aboutModal.style.display = 'flex';
    }
    
    function hideAbout() {
      aboutModal.style.display = 'none';
    }
    
    // 点击模态框背景关闭
    aboutModal.addEventListener('click', (e) => {
      if (e.target === aboutModal) {
        hideAbout();
      }
    });
    
    // 键盘事件处理
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        hideAbout();
      }
    });
    
    // 高德地图功能 - 显示城市边界
    function highlightCity(cityName) {
      console.log('开始高亮城市:', cityName);
      
      // 检查地图对象
      if (!map) {
        console.error('无法高亮城市 - 地图对象不存在');
        alert('地图对象不存在，请先初始化地图');
        return;
      }
      
      // 检查AMap全局对象
      if (typeof AMap === 'undefined') {
        console.error('AMap对象不存在，地图SDK可能未正确加载');
        alert('AMap对象不存在，地图SDK可能未正确加载');
        return;
      }
      
      // 显示一个简单标记，测试基本功能
      try {
        console.log('尝试添加简单标记');
        
        // 北京坐标
        const position = [116.4074, 39.9042];
        
        // 创建标记
        const marker = new AMap.Marker({
          position: position,
          title: '北京市'
        });
        
        // 添加到地图
        marker.setMap(map);
        
        // 调整视图
        map.setCenter(position);
        map.setZoom(12);
        
        console.log('简单标记添加成功');
        
        // 创建简单圆形区域代替复杂边界
        const circle = new AMap.Circle({
          center: position,
          radius: 50000,  // 50公里半径
          fillColor: '#CCF3FF',
          fillOpacity: 0.4,
          strokeColor: '#2563eb',
          strokeWeight: 2,
          strokeOpacity: 0.8
        });
        
        circle.setMap(map);
        console.log('圆形区域添加成功');
        
        // 先尝试基本功能，如果成功再尝试复杂边界
        
        // 清除之前的城市边界
        if (cityPolygon) {
          console.log('清除上一个城市的边界');
          try {
            // 尝试两种可能的移除方法
            map.remove([cityPolygon]);
          } catch (e1) {
            console.log('第一种移除方法失败，尝试替代方法', e1);
            try {
              cityPolygon.setMap(null);
            } catch (e2) {
              console.error('两种移除方法都失败', e2);
            }
          }
          cityPolygon = null;
        }
      } catch (error) {
        console.error('添加简单标记时出错:', error);
        alert('添加地图标记失败: ' + error.message);
      }
    }
    
    // 高德地图功能 - 搜索城市景点
    function searchCityPOIs(cityName, keywords = '旅游景点') {
      console.log('开始搜索城市景点:', cityName, keywords);
      
      // 检查地图对象
      if (!map) {
        console.error('无法搜索景点 - 地图对象不存在');
        alert('地图对象不存在，请先初始化地图');
        return;
      }
      
      // 检查AMap全局对象
      if (typeof AMap === 'undefined') {
        console.error('AMap对象不存在，地图SDK可能未正确加载');
        alert('AMap对象不存在，地图SDK可能未正确加载');
        return;
      }
      
      // 清除之前的标记
      clearMapMarkers();
      
      // 使用模拟数据测试标记功能
      try {
        console.log('使用模拟数据测试标记功能');
        
        // 北京几个著名景点的坐标
        const pois = [
          { name: '故宫博物院', position: [116.3974, 39.9175], type: '博物馆' },
          { name: '天安门广场', position: [116.3977, 39.9055], type: '广场' },
          { name: '颐和园', position: [116.2733, 39.9997], type: '公园' },
          { name: '圆明园', position: [116.303, 40.0086], type: '公园' },
          { name: '八达岭长城', position: [116.0169, 40.3609], type: '名胜古迹' }
        ];
        
        // 为每个景点创建标记
        pois.forEach(poi => {
          // 创建标记
          const marker = new AMap.Marker({
            position: poi.position,
            title: poi.name
          });
          
          // 创建信息窗体
          const infoWindow = new AMap.InfoWindow({
            content: `<div style="padding:10px;">
              <h3 style="margin:0;font-size:14px;">${poi.name}</h3>
              <p style="margin:5px 0;font-size:12px;">类型: ${poi.type}</p>
            </div>`,
            offset: new AMap.Pixel(0, -30)
          });
          
          // 点击标记时显示信息窗体
          marker.on('click', function() {
            infoWindow.open(map, marker.getPosition());
          });
          
          // 添加到地图
          marker.setMap(map);
          mapMarkers.push(marker);
        });
        
        // 调整地图视野以包含所有标记
        map.setCenter([116.3974, 39.9175]); // 以故宫为中心
        map.setZoom(11); // 适当的缩放级别
        
        console.log('模拟数据标记添加成功');
        
        // 如果基本功能正常，再尝试使用PlaceSearch插件
        if (AMap.PlaceSearch) {
          console.log('尝试使用PlaceSearch插件');
          
          try {
            const placeSearch = new AMap.PlaceSearch({
              city: cityName,
              pageSize: 10,
              pageIndex: 1
            });
            
            console.log('PlaceSearch实例创建成功，开始搜索');
            
            placeSearch.search(keywords, function(status, result) {
              console.log('PlaceSearch搜索结果:', status, result ? '有结果' : '无结果');
              // 由于已经显示了模拟数据，这里只记录结果不实际使用
            });
          } catch (error) {
            console.error('PlaceSearch使用失败:', error);
          }
        } else {
          console.warn('PlaceSearch插件不可用');
        }
      } catch (error) {
        console.error('添加景点标记时出错:', error);
        alert('添加景点标记失败: ' + error.message);
      }
    }
    
    // 清除地图上的所有标记
    function clearMapMarkers() {
      console.log('清除地图标记, 当前标记数:', mapMarkers.length);
      if (mapMarkers && mapMarkers.length > 0) {
        try {
          mapMarkers.forEach(marker => {
            try {
              marker.setMap(null);
            } catch (error) {
              console.error('移除标记失败:', error);
            }
          });
        } catch (error) {
          console.error('清除标记时出错:', error);
        }
        mapMarkers.length = 0;
      }
    }

    // 添加全局错误处理
    window.addEventListener('error', function(event) {
      console.error('全局错误:', event.message, event.filename, event.lineno, event.colno);
      if (event.message.includes('AMap') || event.filename.includes('amap')) {
        alert('高德地图API加载或使用出错，请查看控制台获取详细信息');
      }
    });

    // 添加测试功能
    document.addEventListener('DOMContentLoaded', function() {
      // 添加测试按钮
      const testDiv = document.createElement('div');
      testDiv.style.position = 'absolute';
      testDiv.style.top = '80px';
      testDiv.style.left = '20px';
      testDiv.style.zIndex = '1000';
      testDiv.style.backgroundColor = 'white';
      testDiv.style.padding = '10px';
      testDiv.style.borderRadius = '5px';
      testDiv.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
      
      const testButton = document.createElement('button');
      testButton.textContent = '测试标记北京';
      testButton.style.padding = '8px 16px';
      testButton.style.marginRight = '10px';
      testButton.style.backgroundColor = '#2563eb';
      testButton.style.color = 'white';
      testButton.style.border = 'none';
      testButton.style.borderRadius = '4px';
      testButton.style.cursor = 'pointer';
      
      testButton.addEventListener('click', function() {
        console.log('测试按钮点击 - 高亮北京');
        try {
          if (map) {
            console.log('地图对象存在，调用highlightCity函数');
            highlightCity('北京');
          } else {
            console.error('地图对象不存在');
            alert('地图尚未加载完成');
          }
        } catch (error) {
          console.error('高亮北京时出错:', error);
          alert('高亮北京时出错: ' + error.message);
        }
      });
      
      const poiButton = document.createElement('button');
      poiButton.textContent = '显示北京景点';
      poiButton.style.padding = '8px 16px';
      poiButton.style.backgroundColor = '#2563eb';
      poiButton.style.color = 'white';
      poiButton.style.border = 'none';
      poiButton.style.borderRadius = '4px';
      poiButton.style.cursor = 'pointer';
      
      poiButton.addEventListener('click', function() {
        console.log('测试按钮点击 - 搜索北京景点');
        try {
          if (map) {
            console.log('地图对象存在，调用searchCityPOIs函数');
            searchCityPOIs('北京');
          } else {
            console.error('地图对象不存在');
            alert('地图尚未加载完成');
          }
        } catch (error) {
          console.error('搜索北京景点时出错:', error);
          alert('搜索北京景点时出错: ' + error.message);
        }
      });
      
      const checkApiButton = document.createElement('button');
      checkApiButton.textContent = '检查API密钥';
      checkApiButton.style.padding = '8px 16px';
      checkApiButton.style.marginTop = '10px';
      checkApiButton.style.backgroundColor = '#10b981';
      checkApiButton.style.color = 'white';
      checkApiButton.style.border = 'none';
      checkApiButton.style.borderRadius = '4px';
      checkApiButton.style.cursor = 'pointer';
      
      checkApiButton.addEventListener('click', async function() {
        try {
          console.log('检查API密钥...');
          const response = await fetch('/api/gaode-key');
          const data = await response.json();
          
          if (data.error) {
            alert('API密钥错误: ' + data.error);
          } else if (data.key) {
            alert('API密钥获取成功! 密钥前几位: ' + data.key.substring(0, 3) + '***');
          } else {
            alert('API响应异常: ' + JSON.stringify(data));
          }
        } catch (error) {
          console.error('检查API密钥时出错:', error);
          alert('检查API密钥时出错: ' + error.message);
        }
      });
      
      testDiv.appendChild(testButton);
      testDiv.appendChild(poiButton);
      testDiv.appendChild(document.createElement('br'));
      testDiv.appendChild(checkApiButton);
      document.body.appendChild(testDiv);

      // 手动初始化地图
      const initMapButton = document.createElement('button');
      initMapButton.textContent = '手动初始化地图';
      initMapButton.style.padding = '8px 16px';
      initMapButton.style.marginTop = '10px';
      initMapButton.style.backgroundColor = '#f59e0b';
      initMapButton.style.color = 'white';
      initMapButton.style.border = 'none';
      initMapButton.style.borderRadius = '4px';
      initMapButton.style.cursor = 'pointer';
      
      initMapButton.addEventListener('click', function() {
        try {
          console.log('手动初始化地图...');
          initMap();
        } catch (error) {
          console.error('手动初始化地图时出错:', error);
          alert('初始化地图时出错: ' + error.message);
        }
      });
      
      testDiv.appendChild(document.createElement('br'));
      testDiv.appendChild(initMapButton);
    });
  </script>
</body>
</html> 